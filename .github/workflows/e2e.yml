name: E2E

on:
  push:
    branches: [main]
    paths:
      - 'scripts/init.sh'
      - 'tests/e2e/**'
      - 'pyproject.toml'
      - 'python_package_template/**'
      - '.pre-commit-config.yaml'
      - '.github/workflows/e2e.yml'
  pull_request:
    paths:
      - 'scripts/init.sh'
      - 'tests/e2e/**'
      - 'pyproject.toml'
      - 'python_package_template/**'
      - '.pre-commit-config.yaml'
      - '.github/workflows/e2e.yml'
  workflow_dispatch:

permissions:
  contents: read

concurrency:
  group: ${{ github.workflow }}-${{ github.head_ref || github.ref }}
  cancel-in-progress: true

jobs:
  e2e:
    runs-on: ubuntu-latest
    timeout-minutes: 20
    strategy:
      fail-fast: false
      matrix:
        base-image:
          - "python:3.10-slim"
          - "python:3.11-slim"
          - "python:3.12-slim"
          - "python:3.13-slim"
          - "python:3.13-alpine"
        license: ["mit", "none"]
    steps:
      - name: Checkout
        uses: actions/checkout@v6

      - name: Build Docker image
        run: |
          docker build \
            --build-arg "BASE_IMAGE=${{ matrix.base-image }}" \
            -t "e2e-test" \
            -f tests/e2e/Dockerfile \
            .

      - name: Run E2E test (${{ matrix.base-image }}, license=${{ matrix.license }})
        run: docker run --rm e2e-test "${{ matrix.license }}"

  # Gate job â€” single required check for branch protection.
  e2e-pass:
    if: always()
    needs: [e2e]
    runs-on: ubuntu-latest
    timeout-minutes: 1
    steps:
      - name: Verify all E2E checks passed
        run: |
          if [[ "${{ contains(needs.*.result, 'failure') || contains(needs.*.result, 'cancelled') }}" == "true" ]]; then
            echo "One or more E2E jobs failed or were cancelled."
            exit 1
          fi
